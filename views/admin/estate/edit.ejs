<% contentFor('style') %>
<link rel="stylesheet" href="/plugins/select2/dist/css/select2.min.css" />
<link rel="stylesheet" href="/css/persian-datepicker.min.css" />
<link rel="stylesheet" href="/css/select2.css" />
<link rel="stylesheet" href="/css/profilepicker.css" />
<link rel="stylesheet" href="/css/radio.css" />
<link href="https://static.neshan.org/sdk/leaflet/1.4.0/leaflet.css" rel="stylesheet" type="text/css">
<script src="https://static.neshan.org/sdk/leaflet/1.4.0/leaflet.js" type="text/javascript"></script>

<% contentFor('body') %>
<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>ویرایش املاکی</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-left">
                    <li class="breadcrumb-item"><a href="#">لیست مشاوران</a></li>
                    <li class="breadcrumb-item active">ویرایش املاکی</li>
                </ol>
            </div>
        </div>
    </div>
</section>

<section class="card">
    <!--? Card Body -->
    <div class="card-body">
        <form class="form-horizontal content"
            action="/admin/estate/edit/<%= agent._id %>?_method=PUT&_csrf=<%= req.csrfToken() %>" method="post"
            enctype="multipart/form-data">
            <%- include(viewPath('layouts/errors')) -%>

            <div class="card" style="margin-top: 15px;">
                <div class="card-header">
                    <h3 class="card-title">اطلاعات مدیر املاک</h3>
                    <div class="card-tools" style="position: absolute; left: 15px;">
                        <button style="position: absolute; left: 0;" type="button" class="btn btn-tool"
                            data-widget="collapse">
                            <i class="fa fa-minus"></i>
                        </button>
                    </div>
                </div>

                <!--? Select Avatar -->
                <div class="content-group">
                    <div class="row">
                        <div class="card-body p-0">
                            <div class="col-md-12">
                                <div style="padding: 15px;">
                                    <div class="form-group row">
                                        <!--? Select Avatar -->
                                        <label>آواتار کاربر مدیر</label>
                                        <div class="content-group">
                                            <div class="row">
                                                <!--? Profile Picker -->
                                                <div class="col-xs-4">
                                                    <div class="small-12 medium-2 large-2 columns">
                                                        <div class="profile-circle">
                                                            <img id="profile" class="profile-pic"
                                                                src="<%= agent.user.avatar.includes('/images/avatar') ? '/images/profile.png' : agent.user.avatar %>" />
                                                        </div>
                                                        <div class="p-image">
                                                            <i class="fa fa-camera upload-profile-button"></i>
                                                            <i class="fa fa-remove remove-profile-button"></i>
                                                            <input name="profile" class="profile-upload" type="file"
                                                                accept="image/*" hidden />
                                                        </div>
                                                    </div>
                                                </div>
                                                <!--! Profile Picker -->
                                                <div class="col-xs-4">
                                                    <label class="radio">
                                                        <input type="radio" name="avatar" class="radio-select"
                                                            value="/images/avatar-01.png" <%= agent.user.avatar == '/images/avatar-01.png' ?
															'checked' : ''%> />
                                                        <span class="radio-checkmark"></span>
                                                        <img src="/images/avatar-01.png" class="img-avatar" />
                                                    </label>
                                                </div>
                                                <div class="col-xs-4">
                                                    <label class="radio">
                                                        <input type="radio" class="radio-select" name="avatar"
                                                            value="/images/avatar-02.png" <%=
															agent.user.avatar == '/images/avatar-02.png' ? 'checked'
															: ''%> />
                                                        <span class="radio-checkmark"></span>
                                                        <img src="/images/avatar-02.png" class="img-avatar" />
                                                    </label>
                                                </div>
                                                <div class="col-xs-4">
                                                    <label class="radio">
                                                        <input type="radio" name="avatar" class="radio-select"
                                                            value="/images/avatar-03.png" <%= agent.user.avatar == '/images/avatar-03.png' ?
															'checked' : ''%> />
                                                        <span class="radio-checkmark"></span>
                                                        <img src="/images/avatar-03.png" class="img-avatar" />
                                                    </label>
                                                </div>
                                                <div class="col-xs-4">
                                                    <label class="radio">
                                                        <input type="radio" class="radio-select" name="avatar"
                                                            value="/images/avatar-04.png" <%=
															agent.user.avatar == '/images/avatar-04.png' ? 'checked'
															: ''%> />
                                                        <span class="radio-checkmark"></span>
                                                        <img src="/images/avatar-04.png" class="img-avatar" />
                                                    </label>
                                                </div>
                                                <div class="col-xs-4">
                                                    <label class="radio">
                                                        <input type="radio" class="radio-select" name="avatar"
                                                            value="/images/avatar-05.png" <%=
															agent.user.avatar == '/images/avatar-05.png' ? 'checked'
															: ''%> />
                                                        <span class="radio-checkmark"></span>
                                                        <img src="/images/avatar-05.png" class="img-avatar" />
                                                    </label>
                                                </div>
                                                <div class="col-xs-4">
                                                    <label class="radio">
                                                        <input type="radio" name="avatar" class="radio-select"
                                                            value="/images/avatar-06.png" <%= agent.user.avatar == '/images/avatar-06.png' ?
															'checked' : ''%> />
                                                        <span class="radio-checkmark"></span>
                                                        <img src="/images/avatar-06.png" class="img-avatar" />
                                                    </label>
                                                </div>

                                                <div class="col-xs-4">
                                                    <label class="radio">
                                                        <input type="radio" name="avatar" class="radio-select"
                                                            value="/images/avatar-07.png" <%= agent.user.avatar == '/images/avatar-07.png' ?
															'checked' : ''%> />
                                                        <span class="radio-checkmark"></span>
                                                        <img src="/images/avatar-07.png" class="img-avatar" />
                                                    </label>
                                                </div>
                                                <div class="col-xs-4">
                                                    <label class="radio">
                                                        <input type="radio" class="radio-select" name="avatar"
                                                            value="/images/avatar-08.png" <%=
															agent.user.avatar == '/images/avatar-08.png' ? 'checked'
															: ''%> />
                                                        <span class="radio-checkmark"></span>
                                                        <img src="/images/avatar-08.png" class="img-avatar" />
                                                    </label>
                                                </div>
                                                <div class="col-xs-4">
                                                    <label class="radio">
                                                        <input type="radio" name="avatar" class="radio-select"
                                                            value="/images/avatar-09.png" <%= agent.user.avatar == '/images/avatar-09.png' ?
															'checked' : ''%> />
                                                        <span class="radio-checkmark"></span>
                                                        <img src="/images/avatar-09.png" class="img-avatar" />
                                                    </label>
                                                </div>
                                                <div class="col-xs-4">
                                                    <label class="radio">
                                                        <input type="radio" name="avatar" class="radio-select"
                                                            value="/images/avatar-10.png" <%= agent.user.avatar == '/images/avatar-10.png' ?
															'checked' : ''%> />
                                                        <span class="radio-checkmark"></span>
                                                        <img src="/images/avatar-10.png" class="img-avatar" />
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        <!--! Select Avatar -->

                                        <div class="row col-md-12">
                                            <div class="col-md-4">
                                                <label>شماره موبایل</label>
                                                <input name="mobile" type="text" class="form-control formObject"
                                                    value="<%= agent.user.mobile %>" placeholder="شماره موبایل *"
                                                    dir="ltr" />
                                            </div>
                                            <div class="col-md-4">
                                                <label>نام مدیر املاک</label>
                                                <input name="name" type="text" class="form-control formObject"
                                                    placeholder="نام مدیر املاک *" value="<%= agent.user.name %>" />
                                            </div>
                                            <div class="col-md-4">
                                                <label>ایمیل</label>
                                                <input name="email" type="text" class="form-control formObject"
                                                    placeholder="آدرس ایمیل" value="<%= agent.user.email %>"
                                                    dir="ltr" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div class="card mt-4">
                <div class="card-header">
                    <h3 class="card-title">اطلاعات دفتر املاک</h3>
                    <div class="card-tools" style="position: absolute; left: 15px;">
                        <button style="position: absolute; left: 0;" type="button" class="btn btn-tool"
                            data-widget="collapse">
                            <i class="fa fa-minus"></i>
                        </button>
                    </div>
                </div>

                <div class="card-body p-0">
                    <div class="col-md-12">
                        <div style="padding: 15px;">
                            <div class="form-group">
                                <!--? Logo Picker -->
                                <label>لوگو املاک</label>
                                <div class="col-xs-4">
                                    <div class="small-12 medium-2 large-2 columns">
                                        <div class="logo-circle">
                                            <img id="logo" class="logo-pic"
                                                src="<%= agent.logo ? agent.logo[480] : '/images/logo-placeholder.png' %>" />
                                        </div>
                                        <div class="l-image">
                                            <i class="fa fa-camera upload-logo-button"></i>
                                            <i class="fa fa-remove remove-logo-button"></i>
                                            <input name="logo" class="logo-upload" type="file" accept="image/*"
                                                hidden />
                                        </div>
                                    </div>
                                </div>
                                <!--! Logo Picker -->

                                <div class="row col-md-12">
                                    <div class="col-md-6">
                                        <label>تاریخ اعتبار</label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text">
                                                    <i class="fa fa-calendar"></i>
                                                </span>
                                            </div>
                                            <input id="date" value="<%= date(agent.credit).format('jYYYY/jMM/jDD') %>"
                                                class="form-control" />
                                            <input id="credit" name="credit" class="form-control" hidden />
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label>تعداد در کوین</label>
                                        <input name="name" type="text" class="form-control formObject"
                                            style="text-align: left; direction: ltr;" placeholder="تعداد در کوین *"
                                            value="<%= agent.coin %>" />
                                    </div>
                                    <div class="col-md-3">
                                        <label>کد معرفی</label>
                                        <input name="name" type="text" class="form-control formObject" dir="ltr"
                                            value="<%= agent.ref %>" readonly />
                                    </div>
                                    <div class="col-md-6">
                                        <label>عنوان دفتر املاک</label>
                                        <input name="title" type="text" class="form-control formObject"
                                            placeholder="عنوان دفتر املاک *" value="<%= agent.title %>" />
                                    </div>
                                    <div class="col-md-6">
                                        <label>تلفن ثابت</label>
                                        <input name="tell" type="text" class="form-control formObject"
                                            style="text-align: left; direction: ltr;" placeholder="تلفن ثابت"
                                            value="<%= agent.tell %>" />
                                    </div>
                                    <div class="col-md-12">
                                        <label>آدرس</label>
                                        <input name="address" type="text" class="form-control formObject"
                                            placeholder="آدرس *" value="<%= agent.location.address %>" />
                                    </div>
                                    <div class="col-md-6">
                                        <label>استان</label>
                                        <div class="form-group">
                                            <select class="form-control select" id="state" name="state">
                                                <% states.forEach(state => { %>
                                                <option value="<%= state._id %>"
                                                    <%= state._id.equals(agent.location.state) ? 'selected' : ''%> />
                                                <%= state.title %>
                                                </option>
                                                <% }) %>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label>شهر</label>
                                        <div class="form-group">
                                            <select class="form-control select" id="city" name="city">
                                                <% cities.forEach(city => { %>
                                                <option value="<%= city._id %>"
                                                    <%= city._id.equals(agent.location.city) ? 'selected' : ''%> />
                                                <%= city.title %>
                                                </option>
                                                <% }) %>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <label>موقعیت مکانی بر روی نقشه</label>
                                        <div style="margin-top: 15px; display: none;">
                                            <input id="lat" name="lat" type="text" value="<%= complete('lat') %>" />
                                            <input id="lon" name="lon" type="text" value="<%= complete('lon') %>" />
                                        </div>
                                        <div id="map"
                                            style="min-height: 350px; width:100%; background: #eee; border: 2px solid #aaa; margin-bottom: 15px;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <button type="submit" class="btn btn-primary formObject mt-3 col-md-2">
                ویرایش
            </button>
        </form>
    </div>
    <!--! Card Body -->
</section>

<% contentFor('script') %>
<script src="/plugins/jquery/dist/jquery.min.js"></script>
<script src="/plugins/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/js/persian-date.min.js"></script>
<script src="/js/persian-datepicker.min.js"></script>
<script src="/plugins/select2/dist/js/select2.full.min.js"></script>
<script src="/js/select2.js"></script>
<script src="/js/profilepicker.js"></script>
<script src="/js/logopicker.js"></script>
<script src="/js/fetch.js"></script>

<script>
    $(document).ready(function () {
        if ("<%= agent.user.avatar.includes('/images/avatar') %>" != 'true') {

            // Disabled Radio Button
            var radio = document.getElementsByClassName('radio-select');
            for (let i = 0; i < radio.length; i++) {
                radio[i].disabled = true;
                radio[i].checked = false;
            }

            // Add Grayscale Filter
            var img = document.getElementsByClassName('img-avatar');
            for (let i = 0; i < img.length; i++) {
                img[i].classList.add('grayscale');
            }

            // Show Or Hide Element
            $('.upload-profile-button').hide();
            $('.radio-checkmark').hide();
            $('.remove-profile-button').show();
        }
    })

    const URL = '/admin/estate/create/city?_csrf=<%= req.csrfToken() %>';

    $('#state').change(() => {
        let id = $('#state option:selected').val();
        $('#city option').remove();
        postData(URL, { id }).then((data) => {
            data.map((city) => {
                $('#city').append(`<option value="${city._id}">${city.title}</option>`);
            });
        });
    });

    $('#date').pDatepicker({
        observer: true,
        format: 'YYYY/MM/DD',
        altField: '#credit',
        autoClose: true,
        initialValue: false,
        maxDate: new persianDate().add('year', 100).valueOf(),
        minDate: new persianDate().subtract('year', 100).valueOf(),
    });

    var newDate = new Date("<%= agent.credit %>");
    $('#credit').val(newDate.getTime());

    var myMap = new L.Map('map', {
        key: 'web.VoTGvNjZqrBisGIHnHGVAPy7iMe2QrTQiwNOShxh',
        maptype: 'neshan',
        center: ["<%= agent.location.lat != null ? agent.location.lat : 35.699739 %>", "<%= agent.location.lon != null ? agent.location.lon : 51.338097 %>"],
        zoom: 14
    });

    $('.leaflet-container').css('cursor', 'crosshair');

    var marker = new L.Marker({ lat: "<%=agent.location.lat%>", lon: "<%=agent.location.lon%>" }).addTo(myMap);

    myMap.on('click', function (e) {
        if (marker != null)
            myMap.removeLayer(marker)
        marker = new L.Marker(e.latlng).addTo(myMap);
        document.getElementById("lat").value = e.latlng.lat;
        document.getElementById("lon").value = e.latlng.lng;
    });
</script>